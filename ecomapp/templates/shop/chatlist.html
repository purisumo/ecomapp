{% extends '../includes/base.html' %}
{% load static cart_extras %}
{% block title %}Messages{% endblock %}
{% block content %}

{% if user.user_type == 'customer' %}
{% include "../includes/navbar.html" %}
{% else %}
{% include "../includes/sidebar.html" %}
{% endif %}

<section class="message-page {% if user.user_type != 'customer' %}seller-content{% endif %}">
  <div class="page-wrapper">
    <div class="page-container {% if selected_shop %}is-selected-message{% endif %}">
      <div class="left-section">
        <div class="top-wrap">
          <p class="title">Messages</p>
        </div>

        <div class="messages-list-cont">
          {% if shops %}
            {% for shop in shops %}
              <div class="message-list-item {% if not shop.is_read %}meow{% endif %} {% if selected_shop and selected_shop.id == shop.id %}selected{% endif %}" data-shop-id="{{ shop.id }}" data-chat-id="{{ shop.chat_id|default:0 }}">
                <div class="seller-img">
                  <i class="bi bi-person-circle"></i>
                </div>
                <div class="content-info">
                  <p class="name" {% if shop.is_message_read %}style="font-weight:600"{% endif %}>{{ shop.name }}</p>
                  <p class="message-prev">{{ shop.latest_message|default:"Start a conversation" }}</p>
                </div>
                <div class="date-cont">
                  <p>{{ shop.latest_message_date|date:"m/d/Y"|default:"" }}</p>
                  <p>{{ shop.latest_message_time|time:"h:i A"|default:"" }}</p>
                </div>
              </div>
              <hr class="line-separator">
            {% endfor %}
          {% else %}
            <div class="empty-content">
              <p>No messages with sellers has been made yet.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <hr class="line-separator y-axis">

      <div class="right-section">
        {% if error %}
          <div class="empty-content">
            <p>{{ error }}</p>
          </div>
        {% elif selected_shop %}
          <div class="top-wrap">
            <div class="seller">
              <div class="seller-img"><i class="bi bi-person-circle"></i></div>
              <div class="wrapper">
                <a href="{% url 'shop:shop_info' selected_shop.id%}" class="name">{{selected_shop.name}}</a>
              </div>
            </div>
          </div>

          <div class="message-content-wrap">
            <div id="chat-messages"></div>
          </div>

          <div class="bottom-wrap">
            <textarea rows="1" id="message-input" placeholder="Type a message..."></textarea>
            <button id="send-message" class="icon-btn-transparent"><i class="bi bi-send-fill"></i></button>
          </div>
        {% else %}
          <div class="empty-content">
            <p>Select a shop to start chatting</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% block styles %}
<link rel="stylesheet" href="{% static 'css/chat.css' %}">
{% endblock styles %}

{% block scripts %}
<script>
  const userUsername = "{{ user.username|escapejs }}";
  let currentChatId = {{ selected_chat_id|default:0 }};
  let messagesUrl = "{{ messages_url|escapejs }}";
  let sendUrl = "{{ send_url|escapejs }}";
  let pollingInterval = null;

  async function fetchMessages() {
    if (!currentChatId || currentChatId === 0) {
      const messagesDiv = document.getElementById('chat-messages');
      if (messagesDiv) messagesDiv.innerHTML = '<p class="empty-message">Select a chat to view messages</p>';
      return;
    }
    try {
      const response = await fetch(messagesUrl.replace('0', currentChatId));
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      const messagesDiv = document.getElementById('chat-messages');
      if (!messagesDiv) return;
      messagesDiv.innerHTML = '';
      if (Array.isArray(data.messages) && data.messages.length > 0) {
        let currentDate = null;
        data.messages.forEach(msg => {
          const msgDate = new Date(msg.sent_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
          if (msgDate !== currentDate) {
            currentDate = msgDate;
            const dateDiv = document.createElement('p');
            dateDiv.className = 'date';
            dateDiv.textContent = currentDate;
            messagesDiv.appendChild(dateDiv);
          }
          const msgDiv = document.createElement('div');
          msgDiv.className = `messages-cont ${msg.sender === userUsername ? 'customer' : ''}`;
          const contentDiv = document.createElement('div');
          contentDiv.className = 'message-content';
          const messageDiv = document.createElement('div');
          messageDiv.className = 'message';
          messageDiv.innerHTML = `<p>${msg.content}</p>`;
          const timeDiv = document.createElement('p');
          timeDiv.className = 'time';
          timeDiv.textContent = new Date(msg.sent_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
          contentDiv.appendChild(timeDiv);
          contentDiv.appendChild(messageDiv);
          msgDiv.appendChild(contentDiv);
          messagesDiv.appendChild(msgDiv);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } else {
        messagesDiv.innerHTML = '<div class="empty-content" style="margin-top:30%;"><p>No messages yet. <br/>Start a conversation.</p></div>';
      }
    } catch (error) {
      console.error('Error fetching messages:', error);
      const messagesDiv = document.getElementById('chat-messages');
      if (messagesDiv) {
        messagesDiv.innerHTML = '<p class="error">Failed to load messages. Please try again.</p>';
      }
    }
  }

  async function sendMessage() {
    if (!currentChatId || currentChatId === 0) {
      console.warn('No chat selected for sending message');
      return;
    }
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    if (!content) return;

    try {
      const response = await fetch(sendUrl.replace('0', currentChatId), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ content })
      });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      if (data.sender) {
        const messagesDiv = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'messages-cont customer';
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.innerHTML = `<p>${data.content}</p>`;
        const timeDiv = document.createElement('p');
        timeDiv.className = 'time';
        timeDiv.textContent = new Date(data.sent_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
        contentDiv.appendChild(timeDiv);
        contentDiv.appendChild(messageDiv);
        msgDiv.appendChild(contentDiv);
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        input.value = '';
      }
    } catch (error) {
      console.error('Error sending message:', error);
    }
  }

  function startPolling() {
    if (pollingInterval) {
      clearInterval(pollingInterval);
    }
    if (currentChatId && currentChatId !== 0) {
      pollingInterval = setInterval(fetchMessages, 5000);
    }
  }

  document.querySelectorAll('.message-list-item').forEach(item => {
    item.addEventListener('click', () => {
      const shopId = item.dataset.shopId;
      window.location.href = `/shop/chat/${shopId}/`;
    });
  });

  document.getElementById('send-message')?.addEventListener('click', sendMessage);

  document.getElementById('message-input')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Initial load
  if (currentChatId && currentChatId !== 0) {
    fetchMessages();
    startPolling();
  }
</script>
{% endblock scripts %}
{% comment %} <script src="{% static 'js/message.js' %}"></script> {% endcomment %}
{% endblock %}